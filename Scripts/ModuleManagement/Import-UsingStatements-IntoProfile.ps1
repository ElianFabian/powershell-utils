# Import-UsingStatements-IntoProfile.ps1



# From repository: https://github.com/ElianFabian/powershell-utils




$modules = (Get-ChildItem -Path "../../Modules/AutogeneratedModules").BaseName

$autogeneratedTextRegex = "#<([\S\s]*?)>#"


$usingModuleStatments = ""

foreach ($module in $modules)
{
    $usingModuleStatments += "using module $module`n"
}


$SEPARATOR = "### ===================================================================================="

$githubRepository = "https://github.com/ElianFabian/powershell-utils"


$autogeneratedText = @(
    "#<### Modules imported with Importe-UsingStatements-IntoProfile.ps1",
    "# Date when modules were added: $(Get-Date)",
    "# Repository of the modules:    $githubRepository",
    $SEPARATOR, '',
    $usingModuleStatments,
    "$SEPARATOR>#"
) -join "`n"

# Converts the $PROFILE file into unix to be able to read it properly (if this is not done the regex match does not work)
((Get-Content $PROFILE) -join "`n") + "`n" | Set-Content -NoNewline $PROFILE

$previousContent = Get-Content -Path $PROFILE -Raw

$autogeneratedTextMatches = (Select-String -InputObject $previousContent -Pattern $autogeneratedTextRegex -AllMatches).Matches

if ($null -eq $autogeneratedTextMatches) # If there are no matches then no using statement was added, so we prepend it
{
    $newContent = $autogeneratedText + $previousContent

    Set-Content -Path $PROFILE -Value $newContent
}
else # Else we update all the existing ones
{
    foreach ($match in $autogeneratedTextMatches)
    {
        if ($match.Value.Contains($githubRepository))
        {
            $autogeneratedTextUpdated = $previousContent -replace $match.Value, $autogeneratedText

            Set-Content -Path $PROFILE -Value $autogeneratedTextUpdated -NoNewline

            break
        }
    }
}
